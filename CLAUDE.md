# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## Idioma

**Comunicarse siempre en Espa√±ol de Espa√±a** al interactuar con el usuario.

---

## Descripci√≥n del Proyecto

Aplicaci√≥n web inteligente para planificaci√≥n optimizada de listas de compra con IA, utilizando productos de Mercadona (4,429 productos en base de datos).

**Caracter√≠sticas principales:**
- Generaci√≥n autom√°tica de listas y men√∫s con OpenAI GPT-4o-mini
- Formulario conversacional de 8 pasos para capturar preferencias
- Base de datos SupaBase con cat√°logo completo de Mercadona
- Optimizaci√≥n de presupuesto y recomendaciones personalizadas
- Aplicaci√≥n de un solo usuario (sin autenticaci√≥n)
- **Estado:** ‚úÖ DESPLEGADA Y FUNCIONANDO EN PRODUCCI√ìN

## üöÄ Deployment en Producci√≥n

**URL de la aplicaci√≥n:** https://lista-compra-inteligente-ivory.vercel.app

**Repositorio GitHub:** https://github.com/Bazamus/lista-compra-inteligente.git

**Plataforma:** Vercel con funciones serverless

**Estado:** ‚úÖ FUNCIONANDO CORRECTAMENTE

---

## Stack Tecnol√≥gico

### Frontend
- **Framework:** React 18 + TypeScript + Vite
- **Estilos:** Tailwind CSS
- **Animaciones:** Framer Motion
- **Routing:** React Router DOM
- **Estado:** React Context API

### Backend
- **API:** Funciones serverless en Vercel (`lista-compra-inteligente/api/`)
- **Runtime:** Node.js con `@vercel/node`
- **Base de datos:** Supabase (PostgreSQL)
- **IA:** OpenAI GPT-4o-mini

---

## Comandos de Desarrollo

### Instalaci√≥n
```bash
cd lista-compra-inteligente
npm install
```

### Desarrollo
```bash
npm run dev  # Inicia servidor en http://localhost:5173
```

### Build
```bash
npm run build  # TypeScript + Vite build
```

### Linting
```bash
npm run lint  # ESLint
```

### Testing de API
```bash
# Modo desarrollo con componente TestAPI
http://localhost:5173?test=api

# Testing manual de endpoints serverless
npm run preview  # Previsualizar build con API
```

### Debugging Local de API
```bash
# Las funciones serverless en /api solo funcionan en Vercel o con Vercel CLI
npm install -g vercel  # Instalar Vercel CLI global
vercel dev             # Ejecutar entorno serverless local (puerto 3000)

# Alternativamente, usar build + preview
npm run build && npm run preview
```

---

## Arquitectura del Proyecto

### Estructura de Carpetas

```
lista-compra-inteligente/
‚îú‚îÄ‚îÄ api/                          # Serverless functions (Vercel)
‚îÇ   ‚îú‚îÄ‚îÄ productos.ts              # GET /productos con filtros y paginaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ categorias.ts             # GET /categorias con subcategor√≠as
‚îÇ   ‚îú‚îÄ‚îÄ listas.ts                 # CRUD de listas de compra
‚îÇ   ‚îî‚îÄ‚îÄ generar-lista.ts          # POST generaci√≥n con OpenAI
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/               # Componentes reutilizables
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button.tsx        # Bot√≥n con variants
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx        # Navegaci√≥n principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LoadingSpinner.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ forms/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConversationalForm.tsx  # Formulario principal
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProgressIndicator.tsx   # Indicador de progreso
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ steps/            # 8 pasos del formulario
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DurationStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ PeopleStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ BudgetStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ MealsStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ BasicsStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AdditionalStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ RestrictionsStep.tsx
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ SummaryStep.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ListHistoryCard.tsx   # Tarjeta de lista guardada
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ products/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ProductSearchModal.tsx  # Modal b√∫squeda productos
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ProductEditModal.tsx    # Modal edici√≥n productos
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HomePage.tsx          # P√°gina inicial con formulario
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ResultsPage.tsx       # P√°gina de resultados con lista generada
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HistoryPage.tsx       # P√°gina de listas guardadas
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AppContext.tsx        # Estado global de la aplicaci√≥n
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useMultiStepForm.ts   # Hook navegaci√≥n formulario
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useListHistory.ts     # Hook gesti√≥n historial localStorage
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.ts                # Cliente API con tipos
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts           # Cliente Supabase configurado
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # Tipos principales
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ form.types.ts         # Tipos del formulario
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ constants.ts          # Configuraci√≥n y constantes
‚îÇ       ‚îú‚îÄ‚îÄ exportPDF.ts          # Exportaci√≥n a PDF con jsPDF
‚îÇ       ‚îî‚îÄ‚îÄ exportExcel.ts        # Exportaci√≥n a Excel con xlsx
‚îÇ
‚îú‚îÄ‚îÄ mercadata/                    # Datasets de productos (CSV, JSON)
‚îú‚îÄ‚îÄ supabase_schema.sql           # Esquema BD (6 tablas)
‚îú‚îÄ‚îÄ import_mercadona_supabase.sql # Script importaci√≥n
‚îî‚îÄ‚îÄ vercel.json                   # Config despliegue
```

### Patrones de Arquitectura

- **Arquitectura:** MVC con separaci√≥n client/server
- **Principios:** SOLID, componentes reutilizables
- **Estado:** Context API para estado global, hooks locales para componentes
- **Tipos:** TypeScript estricto con interfaces en `src/types/`

### Consideraciones Importantes

**Funciones Serverless:**
- Las API functions en `/api` usan `@vercel/node` y solo se ejecutan correctamente en Vercel
- Para desarrollo local, usar `vercel dev` o trabajar con el build de producci√≥n
- No usar `"type": "module"` en package.json (causa errores con Vercel)

**OpenAI Integration:**
- GPT-4o-mini requiere parsing robusto del JSON (puede devolver markdown)
- Usar regex para extraer JSON del contenido: `/```json\n?([\s\S]*?)\n?```/`
- Manejar timeouts (generaci√≥n puede tomar 10-30 segundos)

**Supabase:**
- Usar cliente configurado en `src/services/supabase.ts`
- RLS (Row Level Security) deshabilitado para app de usuario √∫nico
- 4,429 productos importados - usar paginaci√≥n siempre

---

## Base de Datos (Supabase)

### Proyecto Supabase
- **Project ID:** `hnnjfqokgbhnydkfuhxy`
- **URL:** `https://hnnjfqokgbhnydkfuhxy.supabase.co`

### Tablas Principales

1. **categorias** - Categor√≠as principales
2. **subcategorias** - Subcategor√≠as por categor√≠a
3. **productos** - Cat√°logo completo (4,429 productos)
4. **listas_compra** - Listas generadas por usuario
5. **items_lista** - Productos en cada lista
6. **historial_compras** - Historial para an√°lisis IA

### Ejecuci√≥n de Scripts SQL

Ver instrucciones completas en: [INSTRUCCIONES_EJECUCION_SUPABASE.md](INSTRUCCIONES_EJECUCION_SUPABASE.md)

```bash
# En Dashboard Supabase > SQL Editor:
1. Ejecutar supabase_schema.sql
2. Crear tabla temporal con crear_tabla_temporal.sql
3. Importar CSV desde Table Editor
4. Ejecutar script_conversion_definitivo.sql
```

---

## API Endpoints

Ver documentaci√≥n completa en: [API_DOCUMENTATION.md](API_DOCUMENTATION.md)

### Base URL
- Desarrollo: `http://localhost:5173/api`
- Producci√≥n: `https://tu-dominio.vercel.app/api`

### Endpoints Principales

```typescript
GET  /api/productos       # Filtros: categoria, search, precio_min/max, limit, offset
GET  /api/categorias      # Lista categor√≠as con subcategor√≠as
GET  /api/listas          # Obtener listas, query: lista_id, incluir_items
POST /api/listas          # Crear lista
PUT  /api/listas          # Actualizar lista
DELETE /api/listas        # Eliminar lista
POST /api/generar-lista   # Generar con OpenAI
```

### Cliente API

Usar funciones de `src/lib/api.ts`:

```typescript
import { api } from '@/lib/api';

// Buscar productos
const { productos } = await api.productos.obtener({ search: 'aceite', limit: 10 });

// Generar lista con IA
const resultado = await api.listas.generarConIA({
  numPersonas: 2,
  diasDuracion: 7,
  presupuesto: 50,
  // ... m√°s par√°metros
});
```

---

## Variables de Entorno

Crear archivo `.env` en `lista-compra-inteligente/`:

```env
VITE_SUPABASE_URL=https://hnnjfqokgbhnydkfuhxy.supabase.co
VITE_SUPABASE_ANON_KEY=tu_clave_supabase
VITE_OPENAI_API_KEY=tu_clave_openai
```

**Importante:** Nunca commitear el archivo `.env` (ya est√° en `.gitignore`)

---

## Flujo de la Aplicaci√≥n

1. **HomePage** ‚Üí Usuario inicia formulario
2. **ConversationalForm** ‚Üí 8 pasos interactivos:
   - Duraci√≥n (d√≠as)
   - Personas
   - Presupuesto
   - Preferencias alimentarias (desayuno, comida, cena)
   - Alimentos b√°sicos
   - Productos adicionales (limpieza, etc.)
   - Restricciones diet√©ticas
   - Resumen y confirmaci√≥n
3. **API /generar-lista** ‚Üí OpenAI genera lista optimizada
4. **Resultados** ‚Üí Muestra lista, men√∫s y recomendaciones

---

## Integraci√≥n OpenAI

La generaci√≥n de listas utiliza GPT-4o-mini en `api/generar-lista.ts`.

### Proceso:
1. Recibe par√°metros del formulario
2. Consulta productos en Supabase por categor√≠as
3. Env√≠a prompt estructurado a OpenAI con cat√°logo
4. OpenAI devuelve JSON con productos, cantidades y men√∫s
5. Se calcula presupuesto y se guarda en BD

### Estructura de Respuesta:
```typescript
{
  lista: ListaCompra,
  productos: ItemLista[],
  menus: { [dia: string]: { desayuno, comida, cena } },
  presupuesto_estimado: number,
  recomendaciones: string[]
}
```

---

## Progreso del Proyecto

**Estado actual:** 70% completado (6/9 fases + 2 tareas de FASE 7)

‚úÖ Fases completadas:
- FASE 1: Configuraci√≥n inicial React + TypeScript + Tailwind
- FASE 2: Base de datos Supabase (4,429 productos importados)
- FASE 3: Backend API (4 endpoints funcionales)
- FASE 4: Formulario interactivo (8 pasos completos)
- FASE 5: Integraci√≥n completa OpenAI (generaci√≥n de resultados)
- FASE 6: Funcionalidades core (b√∫squeda, edici√≥n, rec√°lculo)
- FASE 7.1: Historial de listas con localStorage ‚úÖ
- FASE 7.2: Exportaci√≥n a PDF y Excel ‚úÖ

üîÑ Pendientes:
- FASE 7.3-7.5: Compartir lista, comparaci√≥n precios, ofertas
- FASE 8: Testing (Jest, integraci√≥n, optimizaci√≥n)
- FASE 9: Mejoras finales (monitoreo, analytics, documentaci√≥n usuario)

Ver progreso detallado en: [todo.md](todo.md)

---

## Principios de Desarrollo

- **C√≥digo limpio:** Seguir principios SOLID
- **Tipos estrictos:** Usar interfaces TypeScript para todo
- **Componentes reutilizables:** Evitar duplicaci√≥n
- **Responsive:** Mobile-first con Tailwind
- **Performance:** Paginaci√≥n y lazy loading
- **UX:** Formulario conversacional, animaciones fluidas

---

## Despliegue

### Vercel

```bash
# Desde lista-compra-inteligente/
vercel
```

**Configuraci√≥n en vercel.json:**
- Serverless functions en `/api`
- Variables de entorno configuradas
- Build autom√°tico con `npm run build`

**Estado actual:** ‚úÖ DESPLEGADO Y FUNCIONANDO
- URL: https://lista-compra-inteligente-ivory.vercel.app
- Auto-deploy desde GitHub activado
- Variables de entorno configuradas en Vercel Dashboard

### Troubleshooting Com√∫n

**Error 500 en API serverless:**
- Verificar que variables de entorno est√©n configuradas en Vercel Dashboard
- Comprobar que `"type": "module"` NO est√© en package.json
- Revisar logs en Vercel Dashboard > Deployments > Function Logs

**Error parsing JSON de OpenAI:**
- OpenAI puede devolver JSON envuelto en markdown con ```json
- Verificar que el regex de extracci√≥n est√© implementado en `generar-lista.ts`

**Build fails:**
- Ejecutar `npm run build` localmente primero
- Verificar errores TypeScript con `npm run lint`
- Asegurar que todas las dependencias est√©n en `dependencies`, no solo en `devDependencies`

---

## üìä Progreso Actual del Proyecto

**Estado:** ‚úÖ FASE 7.1 y 7.2 COMPLETADAS - HISTORIAL Y EXPORTACI√ìN IMPLEMENTADOS

### ‚úÖ Fases Completadas (70% del proyecto):
1. **FASE 1:** Configuraci√≥n inicial ‚úÖ
2. **FASE 2:** Base de datos SupaBase ‚úÖ
3. **FASE 3:** Backend/API ‚úÖ
4. **FASE 4:** Formulario interactivo ‚úÖ
5. **FASE 5:** Integraci√≥n OpenAI ‚úÖ
6. **FASE 6:** Funcionalidades core ‚úÖ
7. **FASE 7.1:** Historial de listas (localStorage) ‚úÖ
8. **FASE 7.2:** Exportaci√≥n PDF/Excel ‚úÖ

### üéØ Funcionalidades implementadas:
- ‚úÖ Formulario conversacional de 8 pasos
- ‚úÖ Generaci√≥n de listas con IA (OpenAI GPT-4o-mini)
- ‚úÖ ResultsPage con visualizaci√≥n completa
- ‚úÖ Men√∫s semanales planificados
- ‚úÖ C√°lculo de presupuesto y ahorro
- ‚úÖ Lista de productos categorizados
- ‚úÖ Recomendaciones de IA
- ‚úÖ Sistema de b√∫squeda y filtrado de productos
- ‚úÖ Edici√≥n manual de listas generadas
- ‚úÖ A√±adir/eliminar productos din√°micamente
- ‚úÖ Rec√°lculo autom√°tico de presupuesto
- ‚úÖ **Historial de hasta 10 listas guardadas**
- ‚úÖ **P√°gina HistoryPage con gesti√≥n completa**
- ‚úÖ **Exportaci√≥n a PDF profesional**
- ‚úÖ **Exportaci√≥n a Excel con m√∫ltiples hojas**

### üîß Problemas resueltos en deployment:
1. **Error ESM/CommonJS:** Eliminado `"type": "module"` del package.json
2. **Error parsing JSON:** A√±adido regex para extraer JSON del markdown de OpenAI
3. **Variables de entorno:** Configuradas correctamente en Vercel Dashboard
4. **Node.js version:** Especificado Node.js 20.x en .node-version

### üìã Pr√≥ximas fases (FASE 7.3-9):
- Compartir lista por enlace
- Comparaci√≥n de precios entre productos
- Sugerencias de productos en oferta
- Testing automatizado (Jest)
- Monitoreo y analytics

---

## Archivos de Referencia

- **API_DOCUMENTATION.md** - Documentaci√≥n completa de endpoints
- **INSTRUCCIONES_EJECUCION_SUPABASE.md** - Gu√≠a setup base de datos
- **todo.md** - Registro detallado de desarrollo y progreso
- **mercadata/** - Datasets CSV/JSON de productos Mercadona